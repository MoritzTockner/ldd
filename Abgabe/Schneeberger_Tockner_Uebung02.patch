From ea0b5645d0b7a8e4c6b7ef1097a819a7f1cf4f5a Mon Sep 17 00:00:00 2001
From: Moritz Tockner <moritz.tockner@a1.net>
Date: Tue, 29 Oct 2019 08:38:40 +0100
Subject: [PATCH 1/1] Getting rid of format errors.

Working exercise.
---
 linux-de1-soc/drivers/misc/Kconfig  |  6 ++
 linux-de1-soc/drivers/misc/Makefile |  2 +
 linux-de1-soc/drivers/misc/ledpwm.c | 98 +++++++++++++++++++++++++++++
 linux-de1-soc/localversion          |  1 +
 4 files changed, 107 insertions(+)
 create mode 100644 linux-de1-soc/drivers/misc/ledpwm.c
 create mode 100644 linux-de1-soc/localversion

diff --git a/linux-de1-soc/drivers/misc/Kconfig b/linux-de1-soc/drivers/misc/Kconfig
index e579c955d..683ea74ba 100644
--- a/linux-de1-soc/drivers/misc/Kconfig
+++ b/linux-de1-soc/drivers/misc/Kconfig
@@ -783,6 +783,12 @@ config ALTERA_ILC
 	  This enables the Interrupt Latency Counter driver for the Altera
 	  SOCFPGA platform.
 
+config LED_PWM
+	tristate "Led PWM driver"
+	help
+	  This enables the pwm driver for LEDR 0 to 7.
+
+
 source "drivers/misc/c2port/Kconfig"
 source "drivers/misc/eeprom/Kconfig"
 source "drivers/misc/cb710/Kconfig"
diff --git a/linux-de1-soc/drivers/misc/Makefile b/linux-de1-soc/drivers/misc/Makefile
index fd6d0be2d..19552a89a 100644
--- a/linux-de1-soc/drivers/misc/Makefile
+++ b/linux-de1-soc/drivers/misc/Makefile
@@ -56,6 +56,8 @@ obj-$(CONFIG_ECHO)		+= echo/
 obj-$(CONFIG_VEXPRESS_SYSCFG)	+= vexpress-syscfg.o
 obj-$(CONFIG_CXL_BASE)		+= cxl/
 obj-$(CONFIG_PANEL)             += panel.o
+obj-$(CONFIG_LED_PWM)           += ledpwm.o
+
 
 lkdtm-$(CONFIG_LKDTM)		+= lkdtm_core.o
 lkdtm-$(CONFIG_LKDTM)		+= lkdtm_bugs.o
diff --git a/linux-de1-soc/drivers/misc/ledpwm.c b/linux-de1-soc/drivers/misc/ledpwm.c
new file mode 100644
index 000000000..63e5ed815
--- /dev/null
+++ b/linux-de1-soc/drivers/misc/ledpwm.c
@@ -0,0 +1,98 @@
+
+#include <linux/init.h>
+#include <linux/module.h>
+#include <linux/kernel.h>
+#include <linux/printk.h>
+#include <linux/ioport.h>
+#include <linux/jiffies.h>
+#include <linux/errno.h>
+#include <linux/io.h>
+
+#define PWM_MAX 0x7FF
+#define PWM_MIN 0
+#define PWM_INCREMENT 100
+#define PWM_ADDR_BASE 0xFF203080
+#define PWM_NUM_OF_LEDS 8
+#define TIMER_INITIAL_TIME 3000
+#define TIMER_PERIOD 10
+
+static u32 *PWM_Leds;
+static u32 current_pwm_val;
+static int i;
+
+static struct timer_list timer;
+static struct timer_list pattern_timer;
+
+static void pwm_pattern(unsigned long var)
+{
+	for (i = 0; i < PWM_NUM_OF_LEDS; i++)
+		iowrite32(current_pwm_val, PWM_Leds + i);
+
+	if (current_pwm_val >= PWM_MAX - PWM_INCREMENT)
+		current_pwm_val = 0;
+	else
+		current_pwm_val = current_pwm_val + PWM_INCREMENT;
+
+	mod_timer(&pattern_timer, jiffies + msecs_to_jiffies(TIMER_PERIOD));
+}
+
+static void start_pwm_pattern(unsigned long var)
+{
+	pattern_timer.function = pwm_pattern;
+	pattern_timer.data = (unsigned long)&pattern_timer;
+	pattern_timer.expires = jiffies;
+	current_pwm_val = 0;
+
+	add_timer(&pattern_timer);
+}
+
+static int __init ledpwm_init(void)
+{
+	/* Request memory for pwm led registers. */
+	if (request_mem_region(PWM_ADDR_BASE,
+			       PWM_NUM_OF_LEDS,
+			       "PWM Leds") == NULL) {
+		pr_err("Memory request failed.");
+		return -ENOMEM;
+	}
+
+	/* Remap the physical address in virtual memory. */
+	PWM_Leds = ioremap(PWM_ADDR_BASE, PWM_NUM_OF_LEDS);
+	if (PWM_Leds == 0) {
+		pr_err("Memory remoapping failed.");
+		return -ENOMEM;
+	}
+
+	for (i = 0; i < PWM_NUM_OF_LEDS; i++)
+		iowrite32(PWM_MAX, PWM_Leds + i);
+
+
+	/* Initialize timer to start periodic pwm pattern after 3 seconds. */
+	init_timer(&timer);
+	timer.data = (unsigned long)&timer;
+	timer.function = start_pwm_pattern;
+	timer.expires = jiffies + msecs_to_jiffies(TIMER_INITIAL_TIME);
+
+	add_timer(&timer);
+
+	return 0;
+}
+
+static void __exit ledpwm_exit(void)
+{
+	for (i = 0; i < PWM_NUM_OF_LEDS; i++)
+		iowrite32(PWM_MIN, PWM_Leds + i);
+
+	del_timer_sync(&timer);
+	del_timer_sync(&pattern_timer);
+	release_mem_region(PWM_ADDR_BASE, PWM_NUM_OF_LEDS);
+}
+
+module_init(ledpwm_init);
+module_exit(ledpwm_exit);
+
+MODULE_DESCRIPTION("");
+MODULE_AUTHOR("Simon Schneeberger");
+MODULE_AUTHOR("Moritz Tockner");
+MODULE_LICENSE("GPL");
+MODULE_VERSION("1.0");
diff --git a/linux-de1-soc/localversion b/linux-de1-soc/localversion
new file mode 100644
index 000000000..309f6c6b9
--- /dev/null
+++ b/linux-de1-soc/localversion
@@ -0,0 +1 @@
+-de1soc
-- 
2.20.1

